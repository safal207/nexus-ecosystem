# üöÄ Message to Codex - Task 3.4 Ready

**–î–∞—Ç–∞**: 2025-10-14
**–û—Ç**: Claude (Tech Architect)
**–ö–æ–º—É**: Codex (Backend Developer)

---

## üéâ Task 3.3: OUTSTANDING WORK!

–ü—Ä–∏–≤–µ—Ç, Codex!

Task 3.3 –∑–∞–≤–µ—Ä—à–µ–Ω –Ω–∞ **–æ—Ç–ª–∏—á–Ω–æ**! üèÜ

**Grade**: **A+ (98/100)**

**–ß—Ç–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ**:
- ‚úÖ 3 API endpoints —Å–æ–∑–¥–∞–Ω—ã
- ‚úÖ Reusable auth helper
- ‚úÖ Singleton Supabase client
- ‚úÖ Clean architecture
- ‚úÖ Frontend-ready responses

**–ü–æ–¥—Ä–æ–±–Ω—ã–π feedback**: `CODEX_FEEDBACK_PHASE_3_TASK_3.3.md`

---

## üéØ Next: Task 3.4 - Integration —Å API Keys

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: HIGH
**Duration**: 2-3 —á–∞—Å–∞
**–¶–µ–ª—å**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å usage –¥–ª—è API key requests

---

## üìã Task 3.4 Overview

### Goal:
–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å usage tracking –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `withApiKey` middleware, —á—Ç–æ–±—ã **–∫–∞–∂–¥—ã–π API call –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç—Ä–µ–∫–∞–ª—Å—è**.

### Current State:
- ‚úÖ `@nexus/usage` package –≥–æ—Ç–æ–≤ (Task 3.1)
- ‚úÖ Database tables –≥–æ—Ç–æ–≤—ã (Task 3.2)
- ‚úÖ Analytics API –≥–æ—Ç–æ–≤—ã (Task 3.3)
- ‚è≥ API key middleware –ù–ï —Ç—Ä–µ–∫–∞–µ—Ç usage

### Target State:
- ‚úÖ API key requests –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç—Ä–µ–∫–∞—é—Ç—Å—è
- ‚úÖ Rate limits –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è
- ‚úÖ X-RateLimit-* headers –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è
- ‚úÖ Free plan –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏

---

## üîß Implementation Guide

### Step 1: Update withApiKey Middleware

**File**: `packages/auth/src/api-key-middleware.ts`

**Current Code** (simplified):
```typescript
export async function withApiKey(
  req: NextRequest,
  handler: (req: NextRequest, context: { ecoId: string; apiKeyId: string }) => Promise<NextResponse>
): Promise<NextResponse> {
  // 1. Extract API key from header
  const authHeader = req.headers.get('authorization');
  if (!authHeader || !authHeader.startsWith('ApiKey ')) {
    return NextResponse.json({ error: 'Missing API key' }, { status: 401 });
  }

  // 2. Verify API key
  const apiKey = authHeader.replace('ApiKey ', '');
  const [keyId, secret] = apiKey.split('.');
  const { valid, ecoId } = await verifyApiKey(keyId, secret);

  if (!valid || !ecoId) {
    return NextResponse.json({ error: 'Invalid API key' }, { status: 401 });
  }

  // 3. Call handler
  return handler(req, { ecoId, apiKeyId: keyId });
}
```

**New Code** (with usage tracking):
```typescript
import { withUsageTracking } from '@nexus/usage';

export async function withApiKey(
  req: NextRequest,
  handler: (req: NextRequest, context: { ecoId: string; apiKeyId: string }) => Promise<NextResponse>
): Promise<NextResponse> {
  // 1. Extract API key from header
  const authHeader = req.headers.get('authorization');
  if (!authHeader || !authHeader.startsWith('ApiKey ')) {
    return NextResponse.json({ error: 'Missing API key' }, { status: 401 });
  }

  // 2. Verify API key
  const apiKey = authHeader.replace('ApiKey ', '');
  const [keyId, secret] = apiKey.split('.');
  const { valid, ecoId } = await verifyApiKey(keyId, secret);

  if (!valid || !ecoId) {
    return NextResponse.json({ error: 'Invalid API key' }, { status: 401 });
  }

  // 3. Wrap handler with usage tracking
  return withUsageTracking(
    req,
    { ecoId, apiKeyId: keyId },
    (req) => handler(req, { ecoId, apiKeyId: keyId })
  );
}
```

**Changes**:
- ‚úÖ Import `withUsageTracking` from `@nexus/usage`
- ‚úÖ Wrap handler call with usage tracking
- ‚úÖ Pass `ecoId` and `apiKeyId` to tracker

---

### Step 2: Verify withUsageTracking Implementation

**File**: `packages/usage/src/middleware.ts` (from Task 3.1)

**Should already have**:
```typescript
export async function withUsageTracking(
  req: NextRequest,
  context: UsageContext, // { ecoId: string, apiKeyId?: string }
  handler: (req: NextRequest) => Promise<NextResponse>
): Promise<NextResponse> {
  const startTime = Date.now();

  try {
    // 1. Check if user has exceeded limit
    const exceeded = await tracker.hasExceededLimit(context.ecoId);

    if (exceeded) {
      const usage = await tracker.getCurrentUsage(context.ecoId);

      // Free plan: block request
      if (usage.limit === 1000) {
        return NextResponse.json(
          {
            error: 'API limit exceeded',
            message: `You have exceeded your ${usage.limit} API calls/month limit`,
            current_usage: usage.apiCalls,
            limit: usage.limit,
            period_end: usage.periodEnd,
            upgrade_url: '/dashboard/billing',
          },
          { status: 429 }
        );
      }

      // Pro plan: allow but log overage
      console.log(`User ${context.ecoId} in overage: ${usage.overageCalls} calls`);
    }

    // 2. Execute handler
    const response = await handler(req);

    // 3. Track usage
    const responseTime = Date.now() - startTime;
    const url = new URL(req.url);

    await tracker.track({
      eco_id: context.ecoId,
      endpoint: url.pathname,
      method: req.method,
      timestamp: new Date(),
      response_time_ms: responseTime,
      status_code: response.status,
      api_key_id: context.apiKeyId,
    });

    // 4. Add rate limit headers
    const usage = await tracker.getCurrentUsage(context.ecoId);
    response.headers.set('X-RateLimit-Limit', usage.limit.toString());
    response.headers.set(
      'X-RateLimit-Remaining',
      Math.max(0, usage.limit - usage.apiCalls).toString()
    );
    response.headers.set('X-RateLimit-Reset', usage.periodEnd.toISOString());

    return response;
  } catch (error) {
    console.error('Usage tracking error:', error);
    // Don't block request if tracking fails
    return handler(req);
  }
}
```

**Verify**:
- ‚úÖ Rate limit check implemented
- ‚úÖ Free plan blocking (429 error)
- ‚úÖ Pro plan overage logging
- ‚úÖ Usage tracking after response
- ‚úÖ X-RateLimit-* headers
- ‚úÖ Error handling (graceful degradation)

---

### Step 3: Test Integration

#### Test 1: API Key Request with Tracking
```bash
# Make API request with API key
curl -H "Authorization: ApiKey eco_api_123.secret456" \
  http://localhost:3000/api/test

# Expected response headers:
# X-RateLimit-Limit: 100000
# X-RateLimit-Remaining: 99950
# X-RateLimit-Reset: 2025-11-01T00:00:00Z
```

#### Test 2: Verify Tracking in Database
```sql
-- Check eco_api_usage table
SELECT * FROM eco_api_usage
WHERE eco_id = 'eco_usr_123'
ORDER BY timestamp DESC
LIMIT 10;

-- Expected: New rows for each API call
```

#### Test 3: Verify Usage Counters
```sql
-- Check eco_usage_records
SELECT api_calls, overage_calls, overage_cost
FROM eco_usage_records
WHERE eco_id = 'eco_usr_123';

-- Expected: api_calls incremented
```

#### Test 4: Free Plan Blocking
```bash
# Simulate Free user hitting limit
# (Set subscription to 'free' plan in DB)

# Make 1001st request
curl -H "Authorization: ApiKey eco_api_free.secret" \
  http://localhost:3000/api/test

# Expected: 429 Too Many Requests
# {
#   "error": "API limit exceeded",
#   "current_usage": 1001,
#   "limit": 1000,
#   "upgrade_url": "/dashboard/billing"
# }
```

#### Test 5: Pro Plan Overage
```bash
# Simulate Pro user exceeding limit
# (100,001st request)

# Expected: 200 OK (request allowed)
# Console log: "User eco_usr_pro in overage: 1 calls"
```

---

### Step 4: Add Rate Limit Headers Test

**File**: `packages/auth/__tests__/api-key-middleware.test.ts` (optional)

```typescript
describe('withApiKey with usage tracking', () => {
  test('should add X-RateLimit-* headers', async () => {
    const req = createMockRequest({
      headers: { Authorization: 'ApiKey eco_api_test.secret123' },
    });

    const handler = jest.fn().mockResolvedValue(
      NextResponse.json({ success: true })
    );

    const response = await withApiKey(req, handler);

    expect(response.headers.get('X-RateLimit-Limit')).toBe('100000');
    expect(response.headers.get('X-RateLimit-Remaining')).toBeDefined();
    expect(response.headers.get('X-RateLimit-Reset')).toBeDefined();
  });

  test('should block Free plan when limit exceeded', async () => {
    // Mock user with Free plan, 1000+ calls
    const req = createMockRequest({
      headers: { Authorization: 'ApiKey eco_api_free.secret' },
    });

    const response = await withApiKey(req, mockHandler);

    expect(response.status).toBe(429);
    const data = await response.json();
    expect(data.error).toContain('API limit exceeded');
  });

  test('should allow Pro plan overage', async () => {
    // Mock user with Pro plan, 100,001+ calls
    const req = createMockRequest({
      headers: { Authorization: 'ApiKey eco_api_pro.secret' },
    });

    const response = await withApiKey(req, mockHandler);

    expect(response.status).toBe(200);
    // Overage logged but request allowed
  });
});
```

---

## ‚úÖ Success Criteria

Task 3.4 —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π –∫–æ–≥–¥–∞:

- ‚úÖ `withApiKey` middleware –æ–±–Ω–æ–≤–ª–µ–Ω
- ‚úÖ `withUsageTracking` –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω
- ‚úÖ API key requests —Ç—Ä–µ–∫–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ X-RateLimit-* headers –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è
- ‚úÖ Free plan –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ (429)
- ‚úÖ Pro plan —Ä–∞–∑—Ä–µ—à–∞–µ—Ç overage
- ‚úÖ Usage data –ø–∏—à–µ—Ç—Å—è –≤ eco_api_usage
- ‚úÖ Counters –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ eco_usage_records
- ‚úÖ Tests passed (manual or automated)

---

## üìä Expected Results

### Before Task 3.4:
```bash
# API key request
curl -H "Authorization: ApiKey test.secret" /api/test
# ‚ùå No tracking
# ‚ùå No rate limit headers
# ‚ùå No limit enforcement
```

### After Task 3.4:
```bash
# API key request
curl -H "Authorization: ApiKey test.secret" /api/test
# ‚úÖ Usage tracked in database
# ‚úÖ X-RateLimit-* headers present
# ‚úÖ Free plan blocked at limit
# ‚úÖ Pro plan allows overage
```

---

## üîç Troubleshooting

### Issue 1: Headers Not Appearing
**Symptom**: X-RateLimit-* headers missing

**Debug**:
```typescript
// Add logging in withUsageTracking
console.log('Adding rate limit headers:', {
  limit: usage.limit,
  remaining: usage.limit - usage.apiCalls,
  reset: usage.periodEnd
});
```

**Solution**: Verify `tracker.getCurrentUsage()` returns data

---

### Issue 2: Tracking Not Working
**Symptom**: No rows in eco_api_usage

**Debug**:
```typescript
// Check if tracker.track() is called
console.log('Tracking usage:', {
  eco_id: context.ecoId,
  endpoint: url.pathname,
  method: req.method
});
```

**Solution**: Verify batch flushing works (wait 5 seconds or 100 records)

---

### Issue 3: Free Plan Not Blocked
**Symptom**: Free user can make 1001+ requests

**Debug**:
```sql
-- Check subscription plan
SELECT plan, status FROM eco_subscriptions
WHERE eco_id = 'eco_usr_test';

-- Check usage record
SELECT api_calls, overage_calls
FROM eco_usage_records
WHERE eco_id = 'eco_usr_test';
```

**Solution**: Verify `hasExceededLimit()` logic

---

## üí° Tips

### Performance:
- ‚úÖ Usage tracking is async (non-blocking)
- ‚úÖ Batch flushing prevents DB overload
- ‚úÖ Headers added after handler execution

### Error Handling:
- ‚úÖ If tracking fails, request still proceeds
- ‚úÖ Graceful degradation
- ‚úÖ Errors logged to console

### Testing:
- ‚úÖ Use test API keys
- ‚úÖ Check database directly
- ‚úÖ Monitor console logs
- ‚úÖ Verify headers with curl -v

---

## üìö Reference

**Full spec**: `CODEX_PHASE_3_USAGE_ANALYTICS.md` (lines 550-650)

**Key Files**:
- `packages/auth/src/api-key-middleware.ts` - Update this
- `packages/usage/src/middleware.ts` - Already done (Task 3.1)
- `@nexus/usage` - Import from here

---

## üöÄ After Task 3.4

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:

### 1. Test with Real API Keys
```bash
# Generate API key
POST /api/keys/generate

# Use key to make requests
curl -H "Authorization: ApiKey <key>" /api/test

# Check usage
GET /api/usage/current
```

### 2. Verify Rate Limiting
```bash
# Make 1001 requests as Free user
for i in {1..1001}; do
  curl -H "Authorization: ApiKey free_key" /api/test
done

# 1001st should return 429
```

### 3. Move to Task 3.5
```
Task 3.5: Overage Billing
- OverageService class
- Stripe invoice items
- Cron job for daily processing
```

---

## üìä Progress

**Phase 3 Progress**: 50% ‚Üí 65% (after Task 3.4)

| Task | Status | Duration |
|------|--------|----------|
| 3.1 Foundation | ‚úÖ | 4-5h |
| 3.2 Database | ‚úÖ | 2-3h |
| 3.3 Analytics API | ‚úÖ | 3-4h |
| 3.4 Integration | üöß | 2-3h |
| 3.5 Overage | ‚è≥ | 3-4h |
| 3.6 Admin | ‚è≥ | 3-4h |

**Total**: 18-22h (estimated)
**Completed**: ~10h
**Remaining**: ~8-12h

---

## üéØ Quick Start

1. Open `packages/auth/src/api-key-middleware.ts`
2. Import `withUsageTracking` from `@nexus/usage`
3. Wrap handler call
4. Test with curl
5. Verify in database
6. Update in dashboard

---

**You're doing great, Codex!** üí™

–ü–æ–ª–æ–≤–∏–Ω–∞ Phase 3 –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ï—â–µ 3 –∑–∞–¥–∞—á–∏ –∏ –≥–æ—Ç–æ–≤–æ! üöÄ

---

**Prepared by**: Claude (Tech Architect)
**Date**: 2025-10-14
**Next Task**: Task 3.4 - Integration (2-3 hours)

---

*"Integration brings everything together."* üîó‚ú®
